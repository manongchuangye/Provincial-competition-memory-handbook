### CICD基础

```
jenkins_offline.tar 解压后jenkins.tar是gitlab的镜像，docker load -i 导入镜像
```

1. Jenkins持续化集成

```bash
在master节点上使用镜像jenkins/jenkins:2.262-centos部署Jenkins服务，具体要求如下：
（1）容器名称：jenkins；
（2）端口映射：8080:8080；
（3）使用root身份生成容器；
（4）离线安装Jenkins插件；
（5）设置Jenkins用户：chinaskill；密码：000000；
（6）在授权策略中配置“任何用户可以做任何事(没有任何限制)”。
#jenkins 需要编排镜像
docker run -d --name jenkins -p 8080:8080 -u root \ # 必须加root，不然启动不了
-v /home/jenkins_home:/var/jenkins_home \           # 传输文件
-v /var/run/docker.sock:/var/run/docker.sock \      # docker守护进程文件——通信作用
-v /usr/bin/docker:/usr/bin/docker \                # docker命令
-v /usr/bin/kubectl:/usr/local/bin/kubectl \        # kubectl命令
-v /root/.kube:/root/.kube \                        # k8s通信
jenkins/jenkins:2.262-centos 

安装插件
cp -rfv /opt/plugins/* /home/jenkins_home/plugins/ #要在安装插件之前做
docker restart jenkins                             #重启

http://IP:8080访问Jenkins
```

部署Gitlab服务

```
在master节点上使用镜像gitlab/gitlab-ce:12.9.2-ce.0部署Gitlab服务，具体要求如下：
（1）容器名称：mygitlab；
（2）端口映射：1022:22、81:80、443:443；
（3）容器重启策略：always；
（4）设置root用户及密码；
（5）使用root用户登录Gitlab，密码：00000000；
（6）新建项目ChinaskillProject，将/opt/ChinaskillProject中的代码上传到ChinaskillProject项目中。

[root@master ~]# docker run -d -h gitlab -p 1022:22 -p 81:80 -p 443:443 --restart always --name mygitlab gitlab/gitlab-ce:12.9.2-ce.0

```

![image-20221109091550533](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109091550533.png)

配置Jenkins连接maven

```
（1）采用docker in docker的方式在Jenkins内安装maven；
（2）在Jenkins中配置maven信息。
配置Jenkins连接maven

（1）安装maven
由于Jenkins是采用docker in docker的方式启动的，所以需要在jenkins容器内安装maven：

和配置java环境相同
记得要将source 写入/root/.bashrc

（2）连接maven
登录Jenkins首页，点击“系统管理”→“全局工具配置”，点击“新增Maven”，如图所示。取消勾选“自动安装”，填入maven名称和安装路径
```

配置CI/CD

```
（1）新建一个流水线任务ChinaskillProject；
（2）编写流水线脚本，构建ChinaskillProject项目中的gateway和config服务，将构建后的镜像自动上传到Harbor仓库的chinaskillproject项目，并自动发布gateway和config服务到Kubernetes集群的springcloud命名空间下；
（3）配置Webhook；
（4）在Harbor中新建公开项目chinaskillproject。

配置CI/CD
（1）新建任务
登录Jenkins首页，点击左侧导航栏“新建任务”，如图所示，选择构建一个流水线。
点击“确定”，配置构建触发器
记录下GitLab webhook URL的地址（http://10.10.16.10:8080/project/ChinaskillProject），后期配置webhook需要使用。

配置流水线
点击“流水线语法”，如图所示，示例步骤选择“git：Git”，将springcloud项目地址填入仓库URL。
点击“添加”→“jenkins”添加凭据，如图所示。类型选择“Username with password”，用户名和密码为Gitlab仓库的用户名和密码。
添加凭据后选择凭据
点击“生成流水线脚本”
记录生成的值，并将其写入流水线脚本中，完整的流水线脚本如下：
node{

    stage('git clone'){
        //check CODE
        git credentialsId: 'cb90e0a8-8c41-4c29-ab72-e4a562d1f880', url: 'http://10.10.16.10:81/root/chinaskillproject.git'
    }
    stage('maven build'){
        sh '''/usr/local/maven/bin/mvn package -DskipTests -f /var/jenkins_home/workspace/ChinaskillProject'''
    }
    stage('image build'){
        sh '''
              echo $BUILD_ID
              docker build -t 10.10.16.10/chinaskillproject/gateway:$BUILD_ID -f /var/jenkins_home/workspace/ChinaskillProject/gateway/Dockerfile  /var/jenkins_home/workspace/ChinaskillProject/gateway
              docker build -t 10.10.16.10/chinaskillproject/config:$BUILD_ID -f /var/jenkins_home/workspace/ChinaskillProject/config/Dockerfile  /var/jenkins_home/workspace/ChinaskillProject/config'''
    }
    stage('push image'){
        sh '''docker login 10.10.16.10 -u=admin -p=Harbor12345
            docker push 10.10.16.10/chinaskillproject/gateway:$BUILD_ID
            docker push 10.10.16.10/chinaskillproject/config:$BUILD_ID'''
    }
    stage('deploy Rancher'){
        //执行部署脚本
       sh 'sed -i "s/sqshq\\/piggymetrics-gateway/10.10.16.10\\/chinaskillproject\\/gateway:$BUILD_ID/g" /var/jenkins_home/workspace/ChinaskillProject/yaml/deployment/gateway-deployment.yaml'
       sh 'sed -i "s/sqshq\\/piggymetrics-config/10.10.16.10\\/chinaskillproject\\/config:$BUILD_ID/g" /var/jenkins_home/workspace/ChinaskillProject/yaml/deployment/config-deployment.yaml'
       sh 'kubectl create ns springcloud'
       sh 'kubectl apply -f /var/jenkins_home/workspace/ChinaskillProject/yaml/deployment/gateway-deployment.yaml --kubeconfig=/root/.kube/config'
       sh 'kubectl apply -f /var/jenkins_home/workspace/ChinaskillProject/yaml/deployment/config-deployment.yaml --kubeconfig=/root/.kube/config'
       sh 'kubectl apply -f /var/jenkins_home/workspace/ChinaskillProject/yaml/svc/gateway-svc.yaml --kubeconfig=/root/.kube/config'
       sh 'kubectl apply -f /var/jenkins_home/workspace/ChinaskillProject/yaml/svc/config-svc.yaml --kubeconfig=/root/.kube/config'
    }
}
脚本中所有IP均为Harbor仓库的地址
在网页写入完整的流水线脚本，如图所示，完成后点击“应用”
（2）开启Jenkins匿名访问
登录Jenkins首页，点击“系统管理”→“全局安全配置”，配置授权策略允许匿名用户访问
（3）配置Webhook
登录Gitlab，进入ChinaskillProject项目，点击左侧导航栏“Settings”→“Webhooks”，将前面记录的GitLab webhook URL地址填入URL处，禁用SSL认证
点击“Add webhook”添加webhook
点击“Test”→“Push events”进行测试
结果返回HTTP 200则表明Webhook配置成功。
（4）创建仓库项目
登录Harbor，新建项目chinaskillproject，访问级别设置为公开
进入项目查看镜像列表，如图所示，此时为空，无任何镜像：
```

![image-20221109101130994](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109101130994.png)

构建流水线项目

```
将离线插件传入容器
[root@master CICD]# docker cp repository/ jenkins:/root/.m2
如果没有.m2文件进入容器创建以下

点击右侧“#1”可查看控制台输出，此处会显示构建的详细进程
返回项目查看流水线阶段视图
Harbor查看
进入Harbor仓库springcloud项目查看镜像列表，可以看到已自动上传了一个gateway镜像
Kubernetes查看
Pod的启动较慢，需等待3--5分钟。在命令行查看Pod
kubectl get ns
kubectl -n springcloud get pods
kubectl -n springcloud get service

```

![image-20221109102229943](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102229943.png)

![image-20221109102241615](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102241615.png)

![image-20221109102515833](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102515833.png)

通过端口30010访问服务

![image-20221109102452357](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102452357.png)

通过端口30015访问服务

![image-20221109102549987](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102549987.png)

##### 

### GitLab + GitLab-CI + Harbor + Kubernetes架构来构建CICD环境

```
从私有仓库中拉取gitlab:latest镜像，创建gitlab.yaml文件，基于Kubernetes启动GitLab服务，实现web浏览器正常访问GitLab服务。

kubectl run  pods --image=gitlab/gitlab-ce:12.9.2-ce.0 --port=80   --dry-run -o yaml >> gitlab.yaml

kubectl apply -f gitlab.yaml 



kubectl expose pod gitlab --port='80'  --target-port='80' --type='NodePort' --dry-run='client' -o yaml >> svc-gitlab.yaml

kubectl apply -f svc-gitlab.yaml 
```

```

```

```

```

# Jenkins 一战成魔 

[https://blog.csdn.net/Michael_lcf/article/details/124785548]

## 传统环境安装与说明

名称	                   IP地址	                 安装的软件
代码托管服务器	192.168.168.151	Gitlab-12.4.2
持续集成服务器	192.168.168.152	Jenkins-2.190.3，JDK1.8，Maven3.6.2，Git，SonarQube
应用测试服务器	192.168.168.153	JDK1.8，Tomcat8.5

### Gitlab Install and Configuration

```bash
Gitlab 安装
1. 安装相关依赖
yum -y install policycoreutils openssh-server openssh-clients postfix policycoreutils-python

2. 启动ssh服务&设置为开机启动
systemctl enable sshd && sudo systemctl start sshd

3. 设置postfix开机自启，并启动，postfix支持gitlab发信功能
systemctl enable postfix && systemctl start postfix

4. 开放ssh以及http服务，然后重新加载防火墙列表
firewall-cmd --add-service=ssh --permanent
firewall-cmd --add-service=http --permanent
firewall-cmd --reload
# 如果关闭防火墙就不需要做以上配置
systemctl disable firewalld && systemctl stop firewalld

5. 下载gitlab包，并且安装
在线下载安装包：
wget --no-check-certificate https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-12.4.2-ce.0.el7.x86_64.rpm
安装：
rpm -ivh gitlab-ce-12.4.2-ce.0.el7.x86_64.rpm

6. 修改gitlab配置
vim /etc/gitlab/gitlab.rb
修改gitlab访问地址和端口，默认为80，我们改为8000
external_url 'http://192.168.168.151:8000'
nginx['listen_port'] = 8000

7. 重载配置及启动gitlab
#此处耗时较长 耐心等待哦！ 
sudo gitlab-ctl reconfigure
gitlab-ctl restart

9. 把端口添加到防火墙
firewall-cmd --zone=public --add-port=8000/tcp --permanent
firewall-cmd --reload
# 如果关闭防火墙就不需要做以上配置
```

**http://192.168.168.151:8000**
启动成功后，在页面修改管理员root密码admin123，修改密码后即可登录

#### Gitlab添加组、创建用户、创建项目

```
使用管理员 root 创建组，一个组里面可以有多个项目分支，可以将开发添加到组里面进行设置权限，不同的组就是公司不同的开发项目或者服务模块，不同的组添加不同的开发即可实现对开发设置权限的管理。

在 组Group 下创建项目
创建用户的时候，可以选择Regular或Admin类型
创建user成功后，可以使用Edit功能给user一个密码
```

##### 将用户添加到组中

```
选择某个用户组，进行Members管理组的成员
```

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\442426d62956486588c5abdf07f453f9.png)

```
Gitlab用户在组里面有5种不同权限：
Guest：可以创建issue、发表评论，不能读写版本库 Reporter：可以克隆代码，不能提交，QA、PM可以赋予这个权限 。
Developer：可以克隆代码、开发、提交、push，普通开发可以赋予这个权限。
Maintainer：可以创建项目、添加tag、保护分支、添加项目成员、编辑项目，核心开发可以赋予这个权限 。
Owner：可以设置项目访问权限 - Visibility Level、删除项目、迁移项目、管理组成员，开发组长可以赋予这个权限
```

##### 在用户组中创建项目

```
用新用户litaibai/admin123登录到Gitlab，然后在用户组中创建新的项目
```

##### 源码上传到Gitlab仓库

### Jenkins Install and Configuration

#### Jenkins安装

```bash
1）安装JDK
rpm -qa | grep java       
rpm -e --nodeps java*
yum search jdk
#yum search jdk | grep java-1.8.0
yum list | grep java-11

yum install -y java-1.8.0-openjdk.x86_64 java-1.8.0-openjdk-accessibility.x86_64 java-1.8.0-openjdk-devel.x86_64 java-1.8.0-openjdk-headless.x86_64
# yum install -y java-11-openjdk.x86_64 java-11-openjdk-devel.x86_64 java-11-openjdk-headless.x86_64 java-11-openjdk-jmods.x86_64 java-11-openjdk-static-libs.x86_64

java -version
安装目录为：/usr/lib/jvm

2）获取jenkins安装包
下载页面：https://jenkins.io/zh/download/
下载页面：下载路径：https://mirror.gruenehoelle.nl/jenkins/redhat-stable/
安装文件：jenkins-2.361.1-1.1.noarch.rpm
# rpm安装
#wget --no-check-certificate https://mirror.gruenehoelle.nl/jenkins/redhat-stable/jenkins-2.190.1-1.1.noarch.rpm
#wget --no-check-certificate https://mirror.gruenehoelle.nl/jenkins/redhat-stable/jenkins-2.289.2-1.1.noarch.rpm
# wget --no-check-certificate https://mirror.gruenehoelle.nl/jenkins/redhat-stable/jenkins-2.303.1-1.1.noarch.rpm
wget --no-check-certificate https://mirror.gruenehoelle.nl/jenkins/redhat-stable/jenkins-2.346.1-1.1.noarch.rpm

3）把安装包上传到192.168.168.152服务器，进行安装
yum -y install epel-release
yum -y install daemonize
rpm -ivh jenkins-2.346.1-1.1.noarch.rpm

4）修改Jenkins配置
vim /etc/sysconfig/jenkins
修改内容如下：
JENKINS_USER="root"
JENKINS_PORT="8888"

vim /usr/lib/firewalld/services/jenkins.xml 
<port protocol="tcp" port="8888"/>

vim /usr/lib/systemd/system/jenkins.service
Environment="JENKINS_PORT=8888"

systemctl daemon-reload

5）启动Jenkins
systemctl disable firewalld && systemctl stop firewalld
systemctl start jenkins

6）打开浏览器访问
http://192.168.168.152:8888

账户：admin
密码：cat /var/lib/jenkins/secrets/initialAdminPassword

7）跳过插件安装
因为Jenkins插件需连接默认官网下载，速度非常慢且经常会失败，这里暂时选
【选择插件来安装】>>【无】>>【创建第一个管理员用户】>>【保存并完成】>>【保存并完成】
```

#### Jenkins国内插件地址修改

```bash
Jenkins本身不提供很多功能，我们可以通过使用插件来满足我们的使用。例如从Gitlab拉取代码，使用
Maven构建项目等功能需要依靠插件完成。接下来演示如何下载插件。

修改Jenkins插件下载地址
Jenkins国外官方插件地址下载速度非常慢，所以可以修改为国内插件地址：
Jenkins -> Manage Jenkins -> Manage Plugins，点击Available
```

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\61c4b4583f3c4dc88e32614d8fbbebe6.png)

这样做是为了把Jenkins官方的插件列表下载到本地；

修改地址文件，替换为国内插件地址

```bash
#http://updates.jenkinsci.org/download 修改为 https://mirrors.tuna.tsinghua.edu.cn/jenkins
sudo sed -i 's#updates.jenkins.io/download/plugins#mirrors.tuna.tsinghua.edu.cn/jenkins/plugins#g' /var/lib/jenkins/updates/default.json
sudo sed -i 's#www.google.com#www.baidu.com#g' /var/lib/jenkins/updates/default.json
```

最后，Manage Plugins点击Advanced，把Update Site改为国内插件下载地址

```bash
https://updates.jenkins.io/update-center.json
修改为--->>>
https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json
```

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\4f69369b985043339a129d1b03d9aa83.png)

Sumbit后，在浏览器输入重启url。
**http://192.168.168.152:8888/restart**

#### Jenkins中文汉化插件安装

**Jenkins -> Manage Jenkins -> Manage Plugins，点击Available，搜索 “Chinese”，安装，重启**

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\fb9d25351a8b4e7a81b5add055df11f9.png)

#### Jenkins用户权限管理

我们可以利用 Role-based Authorization Strategy 插件来管理Jenkins用户权限

#### 开启权限全局安全配置

【系统管理】->【全局安全配置】->【授权策略 “Role-Based Strategy”】->【 保存】

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\f47a3f37224240759ab68256b117678f.png)

#### 创建角色

【系统管理】->【Manage and Assign Roles】->【Manage Roles】

**Global roles**：管理员等高级用户可以创建基于全局的角色 。
**Project roles**：针对某个或者某些项目的角色 。
**Slave roles**：节点相关的权限。

我们添加以下三个角色：

baseRole：该角色为Global roles。这个角色需要绑定Overall下面的Read权限，是为了给所有用户绑定最基本的Jenkins访问权限。注意：如果不给后续用户绑定这个角色，会报错误：用户名 is missing the Overall/Read permission
role1：该角色为Project roles。使用正则绑定michael.，意思是只能操作michael开头的项目。
role2：该角色为Project roles。使用正则绑定michelle.，意思是只能操作michelle开头的项目。

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\88f5a61b99ce425d805274ada184d4a2.png)

#### 创建用户

【系统管理】->【管理用户】->【新建用户】

创建三个用户：michael/admin123、emily/admin123、michelle/admin123

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\d257d10478de4a979425aae3aae7e88d.png)

此时直接登录是没有任何权限的

#### 给用户分配角色

【系统管理】->【Manage and Assign Roles】->【Assign Roles】

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\10015de3022f4e228aa61e4d45b3b95b.png)

绑定规则如下：
emily用户 绑定 baseRole 和 role1 角色；
michelle用户 绑定 baseRole 和role2 角色；

#### 创建项目验证权限

以john管理员账户创建两个项目 michael-goods 和 michelle-order ；

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\fd022add1ae243aaa0af1b1b42ca9a2b.png)

以emily用户登录，只能看到michael-goods项目：

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\f9b24284684b4db5895ef23e6a3c8891.png)

以michelle用户登录，只能看到michelle-order项目：

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\94081ff4d0fa4f50a8c953ed254df9e6.png)

#### Jenkins凭证管理

要在Jenkins使用凭证管理功能，需要安装Credentials Binding插件；
凭据可以用来存储需要密文保护的数据库密码、Gitlab密码信息、Docker私有仓库密码等，以便Jenkins可以和这些第三方的应用进行交互。

#### 安装Credentials Binding插件

【系统管理】->【插件管理】->【可选插件】->【Credentials Binding】->【安装】

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\847e4d5ce4fa48a689ef966639885477.png)

可以添加的凭证有5种：
Username with password：用户名和密码
SSH Username with private key： 使用SSH用户和密钥
Secret file：需要保密的文本文件，使用时Jenkins会将文件复制到一个临时目录中，再将文件路径
设置到一个变量中，等构建结束后，所复制的Secret file就会被删除。
Secret text：需要保存的一个加密的文本串，如钉钉机器人或Github的api token
Certificate：通过上传证书文件的方式
![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\8cef9cd4db28455488151a86303fd360.png)

常用的凭证类型有：
***Username with password***（用户密码）
***SSH Username with private key***（SSH密钥）

接下来以使用Git工具到Gitlab拉取项目源码为例，演示Jenkins的如何管理Gitlab的凭证。

#### 安装Git插件和Git工具

为了让Jenkins支持从Gitlab拉取源码，需要安装Git插件以及在CentOS7上安装Git工具。
Git插件安装：

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\0658685421794443a92713757f61b23a.png)

CentOS7上安装Git工具：

```
# yum安装git
yum install git -y
# 查看git版本
git --version 
```

#### 创建使用【用户密码类型】凭证

【系统管理】->【Manage Credentials】->【全局】->【添加一些凭据】

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\7907b1281f274384a2a37d300029e858.png)
