### CICD基础

```
jenkins_offline.tar 解压后jenkins.tar是gitlab的镜像，docker load -i 导入镜像
```

1. Jenkins持续化集成

```bash
在master节点上使用镜像jenkins/jenkins:2.262-centos部署Jenkins服务，具体要求如下：
（1）容器名称：jenkins；
（2）端口映射：8080:8080；
（3）使用root身份生成容器；
（4）离线安装Jenkins插件；
（5）设置Jenkins用户：chinaskill；密码：000000；
（6）在授权策略中配置“任何用户可以做任何事(没有任何限制)”。
#jenkins 需要编排镜像
docker run -d --name jenkins -p 8080:8080 -u root \ # 必须加root，不然启动不了
-v /home/jenkins_home:/var/jenkins_home \           # 传输文件
-v /var/run/docker.sock:/var/run/docker.sock \      # docker守护进程文件——通信作用
-v /usr/bin/docker:/usr/bin/docker \                # docker命令
-v /usr/bin/kubectl:/usr/local/bin/kubectl \        # kubectl命令
-v /root/.kube:/root/.kube \                        # k8s通信
jenkins/jenkins:2.262-centos 

安装插件
cp -rfv /opt/plugins/* /home/jenkins_home/plugins/ #要在安装插件之前做
docker restart jenkins                             #重启

http://IP:8080访问Jenkins
```

部署Gitlab服务

```
在master节点上使用镜像gitlab/gitlab-ce:12.9.2-ce.0部署Gitlab服务，具体要求如下：
（1）容器名称：mygitlab；
（2）端口映射：1022:22、81:80、443:443；
（3）容器重启策略：always；
（4）设置root用户及密码；
（5）使用root用户登录Gitlab，密码：00000000；
（6）新建项目ChinaskillProject，将/opt/ChinaskillProject中的代码上传到ChinaskillProject项目中。

[root@master ~]# docker run -d -h gitlab -p 1022:22 -p 81:80 -p 443:443 --restart always --name mygitlab gitlab/gitlab-ce:12.9.2-ce.0

```

![image-20221109091550533](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109091550533.png)

配置Jenkins连接maven

```
（1）采用docker in docker的方式在Jenkins内安装maven；
（2）在Jenkins中配置maven信息。
配置Jenkins连接maven

（1）安装maven
由于Jenkins是采用docker in docker的方式启动的，所以需要在jenkins容器内安装maven：

和配置java环境相同
记得要将source 写入/root/.bashrc

（2）连接maven
登录Jenkins首页，点击“系统管理”→“全局工具配置”，点击“新增Maven”，如图所示。取消勾选“自动安装”，填入maven名称和安装路径
```

配置CI/CD

```
（1）新建一个流水线任务ChinaskillProject；
（2）编写流水线脚本，构建ChinaskillProject项目中的gateway和config服务，将构建后的镜像自动上传到Harbor仓库的chinaskillproject项目，并自动发布gateway和config服务到Kubernetes集群的springcloud命名空间下；
（3）配置Webhook；
（4）在Harbor中新建公开项目chinaskillproject。

配置CI/CD
（1）新建任务
登录Jenkins首页，点击左侧导航栏“新建任务”，如图所示，选择构建一个流水线。
点击“确定”，配置构建触发器
记录下GitLab webhook URL的地址（http://10.10.16.10:8080/project/ChinaskillProject），后期配置webhook需要使用。

配置流水线
点击“流水线语法”，如图所示，示例步骤选择“git：Git”，将springcloud项目地址填入仓库URL。
点击“添加”→“jenkins”添加凭据，如图所示。类型选择“Username with password”，用户名和密码为Gitlab仓库的用户名和密码。
添加凭据后选择凭据
点击“生成流水线脚本”
记录生成的值，并将其写入流水线脚本中，完整的流水线脚本如下：
node{

    stage('git clone'){
        //check CODE
        git credentialsId: 'cb90e0a8-8c41-4c29-ab72-e4a562d1f880', url: 'http://10.10.16.10:81/root/chinaskillproject.git'
    }
    stage('maven build'){
        sh '''/usr/local/maven/bin/mvn package -DskipTests -f /var/jenkins_home/workspace/ChinaskillProject'''
    }
    stage('image build'){
        sh '''
              echo $BUILD_ID
              docker build -t 10.10.16.10/chinaskillproject/gateway:$BUILD_ID -f /var/jenkins_home/workspace/ChinaskillProject/gateway/Dockerfile  /var/jenkins_home/workspace/ChinaskillProject/gateway
              docker build -t 10.10.16.10/chinaskillproject/config:$BUILD_ID -f /var/jenkins_home/workspace/ChinaskillProject/config/Dockerfile  /var/jenkins_home/workspace/ChinaskillProject/config'''
    }
    stage('push image'){
        sh '''docker login 10.10.16.10 -u=admin -p=Harbor12345
            docker push 10.10.16.10/chinaskillproject/gateway:$BUILD_ID
            docker push 10.10.16.10/chinaskillproject/config:$BUILD_ID'''
    }
    stage('deploy Rancher'){
        //执行部署脚本
       sh 'sed -i "s/sqshq\\/piggymetrics-gateway/10.10.16.10\\/chinaskillproject\\/gateway:$BUILD_ID/g" /var/jenkins_home/workspace/ChinaskillProject/yaml/deployment/gateway-deployment.yaml'
       sh 'sed -i "s/sqshq\\/piggymetrics-config/10.10.16.10\\/chinaskillproject\\/config:$BUILD_ID/g" /var/jenkins_home/workspace/ChinaskillProject/yaml/deployment/config-deployment.yaml'
       sh 'kubectl create ns springcloud'
       sh 'kubectl apply -f /var/jenkins_home/workspace/ChinaskillProject/yaml/deployment/gateway-deployment.yaml --kubeconfig=/root/.kube/config'
       sh 'kubectl apply -f /var/jenkins_home/workspace/ChinaskillProject/yaml/deployment/config-deployment.yaml --kubeconfig=/root/.kube/config'
       sh 'kubectl apply -f /var/jenkins_home/workspace/ChinaskillProject/yaml/svc/gateway-svc.yaml --kubeconfig=/root/.kube/config'
       sh 'kubectl apply -f /var/jenkins_home/workspace/ChinaskillProject/yaml/svc/config-svc.yaml --kubeconfig=/root/.kube/config'
    }
}
脚本中所有IP均为Harbor仓库的地址
在网页写入完整的流水线脚本，如图所示，完成后点击“应用”
（2）开启Jenkins匿名访问
登录Jenkins首页，点击“系统管理”→“全局安全配置”，配置授权策略允许匿名用户访问
（3）配置Webhook
登录Gitlab，进入ChinaskillProject项目，点击左侧导航栏“Settings”→“Webhooks”，将前面记录的GitLab webhook URL地址填入URL处，禁用SSL认证
点击“Add webhook”添加webhook
点击“Test”→“Push events”进行测试
结果返回HTTP 200则表明Webhook配置成功。
（4）创建仓库项目
登录Harbor，新建项目chinaskillproject，访问级别设置为公开
进入项目查看镜像列表，如图所示，此时为空，无任何镜像：
```

![image-20221109101130994](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109101130994.png)

构建流水线项目

```
将离线插件传入容器
[root@master CICD]# docker cp repository/ jenkins:/root/.m2
如果没有.m2文件进入容器创建以下

点击右侧“#1”可查看控制台输出，此处会显示构建的详细进程
返回项目查看流水线阶段视图
Harbor查看
进入Harbor仓库springcloud项目查看镜像列表，可以看到已自动上传了一个gateway镜像
Kubernetes查看
Pod的启动较慢，需等待3--5分钟。在命令行查看Pod
kubectl get ns
kubectl -n springcloud get pods
kubectl -n springcloud get service

```

![image-20221109102229943](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102229943.png)

![image-20221109102241615](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102241615.png)

![image-20221109102515833](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102515833.png)

通过端口30010访问服务

![image-20221109102452357](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102452357.png)

通过端口30015访问服务

![image-20221109102549987](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102549987.png)

### 传统安装与说明

##### Gitlab Install and Configuration



##### Jenkins Install and Configuration



##### Maven Install and Configuration





##### Tomcat Install and Configuration





### GitLab + GitLab-CI + Harbor + Kubernetes架构来构建CICD环境

```
从私有仓库中拉取gitlab:latest镜像，创建gitlab.yaml文件，基于Kubernetes启动GitLab服务，实现web浏览器正常访问GitLab服务。

kubectl run  pods --image=gitlab/gitlab-ce:12.9.2-ce.0 --port=80   --dry-run -o yaml >> gitlab.yaml

kubectl apply -f gitlab.yaml 



kubectl expose pod gitlab --port='80'  --target-port='80' --type='NodePort' --dry-run='client' -o yaml >> svc-gitlab.yaml

kubectl apply -f svc-gitlab.yaml 
```

```

```

```

```

