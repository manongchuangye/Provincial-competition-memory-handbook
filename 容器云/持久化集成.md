# CICD基础（dcoker版）

```bash
jenkins_offline.tar 解压后jenkins.tar是gitlab的镜像，docker load -i 导入镜像

[root@k8s-master-node1 ~]# kubectl get node
NAME               STATUS   ROLES                         AGE   VERSION
k8s-master-node1   Ready    control-plane,master,worker   11d   v1.22.1
k8s-worker-node1   Ready    worker                        11d   v1.22.1

[root@k8s-master-node1 ~]# kubectl get cs
Warning: v1 ComponentStatus is deprecated in v1.19+
NAME                 STATUS    MESSAGE                         ERROR
scheduler            Healthy   ok                              
controller-manager   Healthy   ok                              
etcd-0               Healthy   {"health":"true","reason":""}   
```

##### Jenkins持续化集成

```bash
在master节点上使用镜像jenkins/jenkins:2.262-centos部署Jenkins服务，具体要求如下：
（1）容器名称：jenkins；
（2）端口映射：8080:8080；
（3）使用root身份生成容器；
（4）离线安装Jenkins插件；
（5）设置Jenkins用户：chinaskill；密码：000000；
（6）在授权策略中配置“任何用户可以做任何事(没有任何限制)”。
#jenkins 需要编排镜像
docker run -d --name jenkins -p 8080:8080 -u root \ # 必须加root，不然启动不了
-v /home/jenkins_home:/var/jenkins_home \           # 传输文件
-v /var/run/docker.sock:/var/run/docker.sock \      # docker守护进程文件——通信作用
-v /usr/bin/docker:/usr/bin/docker \                # docker命令
-v /usr/bin/kubectl:/usr/local/bin/kubectl \        # kubectl命令
-v /root/.kube:/root/.kube \                        # k8s通信
jenkins/jenkins:2.262-centos 

安装插件
cp -rfv /opt/plugins/* /home/jenkins_home/plugins/ #要在安装插件之前做
docker restart jenkins                             #重启

http://IP:8080访问Jenkins                          #最后访问
```

##### 部署Gitlab服务（可以修改中文）

```bash
在master节点上使用镜像gitlab/gitlab-ce:12.9.2-ce.0部署Gitlab服务，具体要求如下：
（1）容器名称：mygitlab；
（2）端口映射：1022:22、81:80、443:443；
（3）容器重启策略：always；
（4）设置root用户及密码；
（5）使用root用户登录Gitlab，密码：00000000；
（6）新建项目ChinaskillProject，将/opt/ChinaskillProject中的代码上传到ChinaskillProject项目中。

[root@master ~]# docker run -d -h gitlab -p 1022:22 -p 81:80 -p 443:443 --restart always --name mygitlab gitlab/gitlab-ce:12.9.2-ce.0
#这里没有做持久化操作  Gitlab启动较慢，可以通过docker logs查看启动状态

yum install -y git
cd /opt/ChinaskillProject/
git config --global user.name "Administrator"
git config --global user.email "admin@example.com"
git remote remove origin
git remote add origin http://10.24.2.10:81/root/chinaskillproject.git
git add .
git commit -m "Initial commit"
git push -u origin master

```

![image-20221124162314839](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221124162314839.png)

**注意**：gitlab版本不同，老版本可能必须加上.git后缀（个人理解）

![image-20221109091550533](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109091550533.png)

##### 配置Jenkins连接Gitlab（在gitlab生成token在jenkins配置）

```bash
（1）设置Outbound requests；
（2）生成“Access Tokens”并命名为jenkins；
（3）设置Jenkins取消对'/project' end-point进行身份验证；
（4）测试Jenkins与Gitlab的连通性。

# 1.gitlab 允许Webhook和服务对本地网络的请求  ---在扳手-设置-外发请求中勾选
# 2.gitlab 生成用户访问令牌
# 3.jenkins配置全局配置 Gitlab API Token设置                            
 注:记得取消勾选Enable authentication for '/project' end-point	
```

##### 配置Jenkins连接maven

```bash
（1）采用docker in docker的方式在Jenkins内安装maven；
（2）在Jenkins中配置maven信息。
配置Jenkins连接maven

（1）安装maven
由于Jenkins是采用docker in docker的方式启动的，所以需要在jenkins容器内安装maven：
cp -rf /opt/apache-maven-3.6.3-bin.tar.gz /home/jenkins_home/
docker exec -it jenkins bash
tar -zxvf /var/jenkins_home/apache-maven-3.6.3-bin.tar.gz -C .
mv apache-maven-3.6.3/ /usr/local/maven
vi /etc/profile 和配置java环境相同
export M2_HOME=/usr/local/maven  # 行末添加两行
export PATH=$PATH:$M2_HOME/bin

记得要将source 写入/root/.bashrc
# Source global definitions
if [ -f /etc/bashrc ]; then
        . /etc/bashrc
source /etc/profile  # 添加本行
fi

#验证 退出容器重新进入 mvn -v

（2）连接maven
登录Jenkins首页，点击“系统管理”→“全局工具配置”，点击“新增Maven”，如图所示。取消勾选“自动安装”，填入maven名称和安装路径
```

##### 配置CI/CD

```bash
（1）新建一个流水线任务ChinaskillProject；
（2）编写流水线脚本，构建ChinaskillProject项目中的gateway和config服务，将构建后的镜像自动上传到Harbor仓库的chinaskillproject项目，并自动发布gateway和config服务到Kubernetes集群的springcloud命名空间下；
（3）配置Webhook；
（4）在Harbor中新建公开项目chinaskillproject。

配置CI/CD
（1）新建任务
登录Jenkins首页，点击左侧导航栏“新建任务”，如图所示，选择构建一个流水线。
点击“确定”，配置构建触发器
记录下GitLab webhook URL的地址（http://10.10.16.10:8080/project/ChinaskillProject），后期配置webhook需要使用。

配置流水线
点击“流水线语法”，选择“git：Git”，将springcloud项目地址填入仓库URL。
点击“添加”→“jenkins”添加凭据，如图所示。类型选择“Username with password”，用户名和密码为Gitlab仓库的用户名和密码。
添加凭据后选择凭据
点击“生成流水线脚本”
#格式
node{
  stage('自己定义的名称'){
  
  }
}
记录生成的值，并将其写入流水线脚本中，完整的流水线脚本如下：
node{

    stage('git clone'){
        //check CODE
        git credentialsId: 'cb90e0a8-8c41-4c29-ab72-e4a562d1f880', url: 'http://10.10.16.10:81/root/chinaskillproject.git'   #此行是自动生成的，拉取项目
    }
    stage('maven build'){   #注意:不要写mvn 一定要写绝对路径
        sh '''/usr/local/maven/bin/mvn package -DskipTests -f var/jenkins_home/workspace/ChinaskillProject'''    #mvn 打包项目 -DskipTests只打包不测试
    }
    stage('image build'){
        sh '''
              echo $BUILD_ID    #版本更新功能,没运行一次会加一
              docker build -t 10.10.16.10/chinaskillproject/gateway:$BUILD_ID -f /var/jenkins_home/workspace/ChinaskillProject/gateway/Dockerfile  /var/jenkins_home/workspace/ChinaskillProject/gateway
              docker build -t 10.10.16.10/chinaskillproject/config:$BUILD_ID -f /var/jenkins_home/workspace/ChinaskillProject/config/Dockerfile  /var/jenkins_home/workspace/ChinaskillProject/config'''
    }
    stage('push image'){
        sh '''docker login 10.10.16.10 -u=admin -p=Harbor12345    #登录
            docker push 10.10.16.10/chinaskillproject/gateway:$BUILD_ID
            docker push 10.10.16.10/chinaskillproject/config:$BUILD_ID'''
    }
    stage('deploy Rancher'){
        //执行部署脚本
       sh 'sed -i "s/sqshq\\/piggymetrics-gateway/10.10.16.10\\/chinaskillproject\\/gateway:$BUILD_ID/g" /var/jenkins_home/workspace/ChinaskillProject/yaml/deployment/gateway-deployment.yaml'          #改镜像名字，因为node节点上没有此镜像，这两步可以直接改yaml文件，重新上传项目，记得赋予权限才能修改
       sh 'sed -i "s/sqshq\\/piggymetrics-config/10.10.16.10\\/chinaskillproject\\/config:$BUILD_ID/g" /var/jenkins_home/workspace/ChinaskillProject/yaml/deployment/config-deployment.yaml'
       sh 'kubectl create ns springcloud'     
       sh 'kubectl apply -f /var/jenkins_home/workspace/ChinaskillProject/yaml/deployment/gateway-deployment.yaml --kubeconfig=/root/.kube/config'    #指定配置文件，创建两个deployment
       #workspace说明，从gitlab上拉去下来的项目会放在workspace文件夹下
       sh 'kubectl apply -f /var/jenkins_home/workspace/ChinaskillProject/yaml/deployment/config-deployment.yaml --kubeconfig=/root/.kube/config'
       sh 'kubectl apply -f /var/jenkins_home/workspace/ChinaskillProject/yaml/svc/gateway-svc.yaml --kubeconfig=/root/.kube/config'     #指定配置文件，创建两个service
       sh 'kubectl apply -f /var/jenkins_home/workspace/ChinaskillProject/yaml/svc/config-svc.yaml --kubeconfig=/root/.kube/config'     
    }
}
脚本中所有IP均为Harbor仓库的地址
在网页写入完整的流水线脚本，如图所示，完成后点击“应用”
（2）开启Jenkins匿名访问
登录Jenkins首页，点击“系统管理”→“全局安全配置”，配置授权策略允许匿名用户访问
（3）配置Webhook
登录Gitlab，进入ChinaskillProject项目，点击左侧导航栏“Settings”→“Webhooks”，将前面记录的GitLab webhook URL地址填入URL处，禁用SSL认证
点击“Add webhook”添加webhook
点击“Test”→“Push events”进行测试
结果返回HTTP 200则表明Webhook配置成功。
（4）创建仓库项目
登录Harbor，新建项目chinaskillproject，访问级别设置为公开      #一定要创建项目
进入项目查看镜像列表，如图所示，此时为空，无任何镜像：
```

![image-20221109101130994](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109101130994.png)

##### 构建流水线项目

```
将离线插件传入容器
[root@master CICD]# docker cp repository/ jenkins:/root/.m2
如果没有.m2文件进入容器创建以下

点击右侧“#1”可查看控制台输出，此处会显示构建的详细进程
返回项目查看流水线阶段视图
Harbor查看
进入Harbor仓库springcloud项目查看镜像列表，可以看到已自动上传了一个gateway镜像
Kubernetes查看
Pod的启动较慢，需等待3--5分钟。在命令行查看Pod
kubectl get ns
kubectl -n springcloud get pods
kubectl -n springcloud get service

```

![image-20221109102229943](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102229943.png)

![image-20221109102241615](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102241615.png)

![image-20221109102515833](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102515833.png)

通过端口30010访问服务

![image-20221109102452357](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102452357.png)

通过端口30015访问服务

![image-20221109102549987](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221109102549987.png)

##############################################

![image-20221124203338820](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221124203338820.png)

![image-20221124203317231](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221124203317231.png)

出现了这个报错是因为jenkins解析不到.kube下那个集群认证文件里的地址，所以kubectl命令不能用

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\SL2SKWVV[]%2IG[MI5]VTJB.png)

![image-20221124203527714](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221124203527714.png)

像这样写的不是ip，所以解析不到

要在/etc/hosts文件中添加一条解析

```
10.10.16.10 apiserver.cluster.local
#虚拟机ip    
```

# dockers-compose版

CICD_Offline.tar

```
 tar -zxvf CICD_Offline.tar -C /opt/
 docker load -i jenkins.tar
  kubectl get cs
  kubectl get nodes
```

##### 安装Jenkins

```yaml
[root@master ~]# mkdir jenkins
[root@master ~]# cd jenkins
[root@master jenkins]# vi docker-compose.yaml
version: '3'
services:
  jenkins:
    image: 'jenkins/jenkins:2.262-centos'
    volumes:
      - /home/jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker
      - /usr/bin/kubectl:/usr/local/bin/kubectl
      - /root/.kube:/root/.kube
    ports:
      - "8080:8080"
    expose:
      - "8080"
      - "50000"                   # 默认情况基于JNLP的jenkins代理通过TCP端口50000于jenkins主站进行通信
    privileged: true              # 给容器以root权限，允许容器中运行一些特权命令
    user: root                    # 指定容器中运行应用的用户名
    restart: always
    container_name: jenkins
    
docker-compose -f docker-compose.yaml up -d
docker-compose ps
#安装插件
cp -rfv /opt/plugins/* /home/jenkins_home/plugins/  #最好不要直接挂载上，挂载的本机目录一般都是空目录
docker restart jenkins

新建用户springcloud
退出admin用户登录，使用新创建的用户登录Jenkins。
依次点击 “系统配置”按钮进入系统配置界面，在“Resource root URL”处配置Jenkins URL
```

![image-20221125112001540](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221125112001540.png)

##### 部署Gitlab

```yaml
编写Gitlab编排文件:
[root@master ~]# mkdir gitlab
[root@master ~]# cd gitlab/
[root@master gitlab]# vi docker-compose.yaml
version: '3'
services:
  gitlab:
    image: 'gitlab/gitlab-ce:12.9.2-ce.0'
    container_name: gitlab
    restart: always
    hostname: '192.168.200.30'     #一定要修改主机名吗?
    privileged: true               #允许特权指令
    environment:
      TZ: 'Asia/Shanghai'          #修改时区，一定要修改时区吗?
    ports:
      - '81:80'
      - '443:443'
      - '1022:22'
    volumes:                       #数据持久化可以不写
      - /srv/gitlab/config:/etc/gitlab
      - /srv/gitlab/gitlab/logs:/var/log/gitlab
      - /srv/gitlab/gitlab/data:/var/opt/gitlab
      
docker-compose up -d
Gitlab启动较慢，可以通过docker logs查看启动状态
```

创建项目springcloud，可见等级选择“Public”，push源代码到gitlab的springcloud项目

```bash
[root@master ~]# yum install -y git
[root@master ~]# cd /opt/springcloud/
[root@master springcloud]# git config --global user.name "administrator"
[root@master springcloud]# git config --global user.email "admin@example.com"
[root@master springcloud]# git remote remove origin
[root@master springcloud]# git remote add origin http://192.168.200.30:81/root/springcloud.git
[root@master springcloud]# git add .
[root@master springcloud]# git commit -m "initial commit"
[root@master springcloud]# git push -u origin master
```

##### 配置Jenkins连接Gitlab

```bash
#1. gitlab生成Token
   点击左侧导航栏的“Settings”→“Network”，设置“Outbound requests”，勾选“Allow requests to the local network from web hooks and services”
    点击Gitlab用户头像图标，点击“Settings”，点击左侧导航栏的“Access Tokens”添加token，点击“Create personal access token”生成Token
    
#2. 复制Token，配置jenkins
    登录Jenkins首页，点击“系统管理”→“系统配置”，配置Gitlab信息，取消勾选“Enable authentication for '/project' end-point”
    点击“添加”→“Jenkins”添加认证信息，将Gitlab API Token填入，点击“Test Connection”
```

##### 配置Jenkins连接maven

```bash
$1. 安装maven
[root@master ~]# cp -rf /opt/apache-maven-3.6.3-bin.tar.gz /home/jenkins_home/
[root@master ~]# docker exec -it jenkins bash
[root@344d4fa5b8ea:/]# tar -zxvf /var/jenkins_home/apache-maven-3.6.3-bin.tar.gz -C .
[root@344d4fa5b8ea:/]# mv apache-maven-3.6.3/ /usr/local/maven
[root@344d4fa5b8ea:/]# vi /etc/profile
export M2_HOME=/usr/local/maven  # 行末添加两行
export PATH=$PATH:$M2_HOME/bin
[root@344d4fa5b8ea /]# vi /root/.bashrc
# .bashrc

# User specific aliases and functions

alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'

# Source global definitions
if [ -f /etc/bashrc ]; then
        . /etc/bashrc
source /etc/profile  # 添加本行
fi
#退出容器重新进入：
[root@344d4fa5b8ea /]# mvn -v

$2. 连接maven
登录Jenkins首页，点击“系统管理”→“全局工具配置”,点击“新增Maven”，如图所示。取消勾选“自动安装”，填入maven名称和安装路径，配置完成后点击“应用”
```

##### 配置CI/CD

```sh
新建流水线任务
记录下GitLab webhook URL的地址（http://192.168.200.30:8080/project/springcloud），后期配置webhook需要使用

node{

    stage('git clone'){
        //check CODE
        git credentialsId: '52c1bc94-ab95-44ee-8159-47eb906fd1f0', url: 'http://192.168.200.30:81/root/springcloud.git'
    }
    stage('maven build'){
        sh '''/usr/local/maven/bin/mvn package -DskipTests -f /var/jenkins_home/workspace/springcloud'''     #打包之后哪里用到了这个？-DskipTests 一个横杠
    } 
    stage('image build'){
        sh '''
              echo $BUILD_ID
              docker build -t 192.168.200.30/springcloud/gateway:$BUILD_ID -f /var/jenkins_home/workspace/springcloud/gateway/Dockerfile  /var/jenkins_home/workspace/springcloud/gateway
              docker build -t 192.168.200.30/springcloud/config:$BUILD_ID -f /var/jenkins_home/workspace/springcloud/config/Dockerfile  /var/jenkins_home/workspace/springcloud/config'''
    }
    stage('test'){
        sh '''docker run -itd --name gateway 192.168.200.30/springcloud/gateway:$BUILD_ID
        docker ps -a|grep springcloud|grep Up
        if [ $? -eq 0 ];then
            echo "Success!"
            docker rm -f gateway
        else
            docker rm -f gateway
            exit 1
            fi
        
        '''
    }
    stage('upload registry'){
        sh '''docker login 192.168.200.30 -u=admin -p=Harbor12345
            docker push 192.168.200.30/springcloud/gateway:$BUILD_ID
            docker push 192.168.200.30/springcloud/config:$BUILD_ID'''
    }
    stage('deploy Rancher'){
        //执行部署脚本
       sh 'sed -i "s/sqshq\\/piggymetrics-gateway/192.168.200.30\\/springcloud\\/gateway:$BUILD_ID/g" /var/jenkins_home/workspace/springcloud/yaml/deployment/gateway-deployment.yaml'
       sh 'sed -i "s/sqshq\\/piggymetrics-config/192.168.200.30\\/springcloud\\/config:$BUILD_ID/g" /var/jenkins_home/workspace/springcloud/yaml/deployment/config-deployment.yaml'
       sh 'kubectl create ns springcloud'
       sh 'kubectl apply -f /var/jenkins_home/workspace/springcloud/yaml/deployment/gateway-deployment.yaml --kubeconfig=/root/.kube/config'
       sh 'kubectl apply -f /var/jenkins_home/workspace/springcloud/yaml/deployment/config-deployment.yaml --kubeconfig=/root/.kube/config'
       sh 'kubectl apply -f /var/jenkins_home/workspace/springcloud/yaml/svc/gateway-svc.yaml --kubeconfig=/root/.kube/config'
       sh 'kubectl apply -f /var/jenkins_home/workspace/springcloud/yaml/svc/config-svc.yaml --kubeconfig=/root/.kube/config'
        
    }
}

```

开启Jenkins匿名访问

登录Gitlab，进入springcloud项目，点击左侧导航栏“Settings”→“Webhooks”，将前面记录的GitLab webhook URL地址填入URL处，禁用SSL认证

创建仓库项目

```
docker cp /opt/repository/ jenkins:/root/.m2/
docker restart jenkins
```

##### Hook executed successfully but returned HTTP 403

![image-20221125160059492](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221125160059492.png)

最后测试报错

![image-20221125160157944](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221125160157944.png)

1. 进入jenkins：

Manage Jenkins- >Configure Global Security -> 授权策略 -> Logged-in users can do anything （登录用户可以做任何事情） 点选 -> 匿名用户具有可读权限 点选

2. 去掉跨站点请求伪造 点选 放开

Manage Jenkins- >Configure Global Security -> CSRF Protection（跨站请求伪造保护）

3. 去掉Gitlab enable authentication 点选 放开

系统管理 -> 系统设置 -> Enable authentication for '/project' end-point

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FucWl4aWFuZw==,size_16,color_FFFFFF,t_70.png)



![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FucWl4aWFuZw==,size_16,color_FFFFFF,t_70-16693636678876.png)

##### 流水线出错

![image-20221125160411942](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221125160411942.png)

![image-20221125162246805](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221125162246805.png)

##### 经验

![image-20221125161300612](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221125161300612.png)

![image-20221125161740694](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\image-20221125161740694.png)

# k8s版

GitLab + GitLab-CI + Harbor + Kubernetes架构来构建CICD环境

```
从私有仓库中拉取gitlab:latest镜像，创建gitlab.yaml文件，基于Kubernetes启动GitLab服务，实现web浏览器正常访问GitLab服务。

kubectl run  pods --image=gitlab/gitlab-ce:12.9.2-ce.0 --port=80   --dry-run -o yaml >> gitlab.yaml

kubectl apply -f gitlab.yaml 



kubectl expose pod gitlab --port='80'  --target-port='80' --type='NodePort' --dry-run='client' -o yaml >> svc-gitlab.yaml

kubectl apply -f svc-gitlab.yaml 
```

```

```

```

```

# Jenkins 一战成魔 (黑马)

[https://blog.csdn.net/Michael_lcf/article/details/124785548]

## 传统环境安装与说明

名称	                   IP地址	                 安装的软件
代码托管服务器	192.168.168.151	Gitlab-12.4.2
持续集成服务器	192.168.168.152	Jenkins-2.190.3，JDK1.8，Maven3.6.2，Git，SonarQube
应用测试服务器	192.168.168.153	JDK1.8，Tomcat8.5

### Gitlab Install and Configuration

```bash
Gitlab 安装
1. 安装相关依赖
yum -y install policycoreutils openssh-server openssh-clients postfix policycoreutils-python

2. 启动ssh服务&设置为开机启动
systemctl enable sshd && sudo systemctl start sshd

3. 设置postfix开机自启，并启动，postfix支持gitlab发信功能
systemctl enable postfix && systemctl start postfix

4. 开放ssh以及http服务，然后重新加载防火墙列表
firewall-cmd --add-service=ssh --permanent
firewall-cmd --add-service=http --permanent
firewall-cmd --reload
# 如果关闭防火墙就不需要做以上配置
systemctl disable firewalld && systemctl stop firewalld

5. 下载gitlab包，并且安装
在线下载安装包：
wget --no-check-certificate https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-12.4.2-ce.0.el7.x86_64.rpm
安装：
rpm -ivh gitlab-ce-12.4.2-ce.0.el7.x86_64.rpm

6. 修改gitlab配置
vim /etc/gitlab/gitlab.rb
修改gitlab访问地址和端口，默认为80，我们改为8000
external_url 'http://192.168.168.151:8000'
nginx['listen_port'] = 8000

7. 重载配置及启动gitlab
#此处耗时较长 耐心等待哦！ 
sudo gitlab-ctl reconfigure
gitlab-ctl restart

9. 把端口添加到防火墙
firewall-cmd --zone=public --add-port=8000/tcp --permanent
firewall-cmd --reload
# 如果关闭防火墙就不需要做以上配置
```

**http://192.168.168.151:8000**
启动成功后，在页面修改管理员root密码admin123，修改密码后即可登录

#### Gitlab添加组、创建用户、创建项目

```
使用管理员 root 创建组，一个组里面可以有多个项目分支，可以将开发添加到组里面进行设置权限，不同的组就是公司不同的开发项目或者服务模块，不同的组添加不同的开发即可实现对开发设置权限的管理。

在 组Group 下创建项目
创建用户的时候，可以选择Regular或Admin类型
创建user成功后，可以使用Edit功能给user一个密码
```

##### 将用户添加到组中

```
选择某个用户组，进行Members管理组的成员
```

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\442426d62956486588c5abdf07f453f9.png)

```
Gitlab用户在组里面有5种不同权限：
Guest：可以创建issue、发表评论，不能读写版本库 Reporter：可以克隆代码，不能提交，QA、PM可以赋予这个权限 。
Developer：可以克隆代码、开发、提交、push，普通开发可以赋予这个权限。
Maintainer：可以创建项目、添加tag、保护分支、添加项目成员、编辑项目，核心开发可以赋予这个权限 。
Owner：可以设置项目访问权限 - Visibility Level、删除项目、迁移项目、管理组成员，开发组长可以赋予这个权限
```

##### 在用户组中创建项目

```
用新用户litaibai/admin123登录到Gitlab，然后在用户组中创建新的项目
```

##### 源码上传到Gitlab仓库

### Jenkins Install and Configuration

#### Jenkins安装

```bash
1）安装JDK
rpm -qa | grep java       
rpm -e --nodeps java*
yum search jdk
#yum search jdk | grep java-1.8.0
yum list | grep java-11

yum install -y java-1.8.0-openjdk.x86_64 java-1.8.0-openjdk-accessibility.x86_64 java-1.8.0-openjdk-devel.x86_64 java-1.8.0-openjdk-headless.x86_64
# yum install -y java-11-openjdk.x86_64 java-11-openjdk-devel.x86_64 java-11-openjdk-headless.x86_64 java-11-openjdk-jmods.x86_64 java-11-openjdk-static-libs.x86_64

java -version
安装目录为：/usr/lib/jvm

2）获取jenkins安装包
下载页面：https://jenkins.io/zh/download/
下载页面：下载路径：https://mirror.gruenehoelle.nl/jenkins/redhat-stable/
安装文件：jenkins-2.361.1-1.1.noarch.rpm
# rpm安装
#wget --no-check-certificate https://mirror.gruenehoelle.nl/jenkins/redhat-stable/jenkins-2.190.1-1.1.noarch.rpm
#wget --no-check-certificate https://mirror.gruenehoelle.nl/jenkins/redhat-stable/jenkins-2.289.2-1.1.noarch.rpm
# wget --no-check-certificate https://mirror.gruenehoelle.nl/jenkins/redhat-stable/jenkins-2.303.1-1.1.noarch.rpm
wget --no-check-certificate https://mirror.gruenehoelle.nl/jenkins/redhat-stable/jenkins-2.346.1-1.1.noarch.rpm

3）把安装包上传到192.168.168.152服务器，进行安装
yum -y install epel-release
yum -y install daemonize
rpm -ivh jenkins-2.346.1-1.1.noarch.rpm

4）修改Jenkins配置
vim /etc/sysconfig/jenkins
修改内容如下：
JENKINS_USER="root"
JENKINS_PORT="8888"

vim /usr/lib/firewalld/services/jenkins.xml 
<port protocol="tcp" port="8888"/>

vim /usr/lib/systemd/system/jenkins.service
Environment="JENKINS_PORT=8888"

systemctl daemon-reload

5）启动Jenkins
systemctl disable firewalld && systemctl stop firewalld
systemctl start jenkins

6）打开浏览器访问
http://192.168.168.152:8888

账户：admin
密码：cat /var/lib/jenkins/secrets/initialAdminPassword

7）跳过插件安装
因为Jenkins插件需连接默认官网下载，速度非常慢且经常会失败，这里暂时选
【选择插件来安装】>>【无】>>【创建第一个管理员用户】>>【保存并完成】>>【保存并完成】
```

#### Jenkins国内插件地址修改

```bash
Jenkins本身不提供很多功能，我们可以通过使用插件来满足我们的使用。例如从Gitlab拉取代码，使用
Maven构建项目等功能需要依靠插件完成。接下来演示如何下载插件。

修改Jenkins插件下载地址
Jenkins国外官方插件地址下载速度非常慢，所以可以修改为国内插件地址：
Jenkins -> Manage Jenkins -> Manage Plugins，点击Available
```

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\61c4b4583f3c4dc88e32614d8fbbebe6.png)

这样做是为了把Jenkins官方的插件列表下载到本地；

修改地址文件，替换为国内插件地址

```bash
#http://updates.jenkinsci.org/download 修改为 https://mirrors.tuna.tsinghua.edu.cn/jenkins
sudo sed -i 's#updates.jenkins.io/download/plugins#mirrors.tuna.tsinghua.edu.cn/jenkins/plugins#g' /var/lib/jenkins/updates/default.json
sudo sed -i 's#www.google.com#www.baidu.com#g' /var/lib/jenkins/updates/default.json
```

最后，Manage Plugins点击Advanced，把Update Site改为国内插件下载地址

```bash
https://updates.jenkins.io/update-center.json
修改为--->>>
https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json
```

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\4f69369b985043339a129d1b03d9aa83.png)

Sumbit后，在浏览器输入重启url。
**http://192.168.168.152:8888/restart**

#### Jenkins中文汉化插件安装

**Jenkins -> Manage Jenkins -> Manage Plugins，点击Available，搜索 “Chinese”，安装，重启**

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\fb9d25351a8b4e7a81b5add055df11f9.png)

#### Jenkins用户权限管理

我们可以利用 Role-based Authorization Strategy 插件来管理Jenkins用户权限

#### 开启权限全局安全配置

【系统管理】->【全局安全配置】->【授权策略 “Role-Based Strategy”】->【 保存】

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\f47a3f37224240759ab68256b117678f.png)

#### 创建角色

【系统管理】->【Manage and Assign Roles】->【Manage Roles】

**Global roles**：管理员等高级用户可以创建基于全局的角色 。
**Project roles**：针对某个或者某些项目的角色 。
**Slave roles**：节点相关的权限。

我们添加以下三个角色：

baseRole：该角色为Global roles。这个角色需要绑定Overall下面的Read权限，是为了给所有用户绑定最基本的Jenkins访问权限。注意：如果不给后续用户绑定这个角色，会报错误：用户名 is missing the Overall/Read permission
role1：该角色为Project roles。使用正则绑定michael.，意思是只能操作michael开头的项目。
role2：该角色为Project roles。使用正则绑定michelle.，意思是只能操作michelle开头的项目。

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\88f5a61b99ce425d805274ada184d4a2.png)

#### 创建用户

【系统管理】->【管理用户】->【新建用户】

创建三个用户：michael/admin123、emily/admin123、michelle/admin123

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\d257d10478de4a979425aae3aae7e88d.png)

此时直接登录是没有任何权限的

#### 给用户分配角色

【系统管理】->【Manage and Assign Roles】->【Assign Roles】

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\10015de3022f4e228aa61e4d45b3b95b.png)

绑定规则如下：
emily用户 绑定 baseRole 和 role1 角色；
michelle用户 绑定 baseRole 和role2 角色；

#### 创建项目验证权限

以john管理员账户创建两个项目 michael-goods 和 michelle-order ；

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\fd022add1ae243aaa0af1b1b42ca9a2b.png)

以emily用户登录，只能看到michael-goods项目：

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\f9b24284684b4db5895ef23e6a3c8891.png)

以michelle用户登录，只能看到michelle-order项目：

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\94081ff4d0fa4f50a8c953ed254df9e6.png)

#### Jenkins凭证管理

要在Jenkins使用凭证管理功能，需要安装Credentials Binding插件；
凭据可以用来存储需要密文保护的数据库密码、Gitlab密码信息、Docker私有仓库密码等，以便Jenkins可以和这些第三方的应用进行交互。

#### 安装Credentials Binding插件

【系统管理】->【插件管理】->【可选插件】->【Credentials Binding】->【安装】

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\847e4d5ce4fa48a689ef966639885477.png)

可以添加的凭证有5种：
Username with password：用户名和密码
SSH Username with private key： 使用SSH用户和密钥
Secret file：需要保密的文本文件，使用时Jenkins会将文件复制到一个临时目录中，再将文件路径
设置到一个变量中，等构建结束后，所复制的Secret file就会被删除。
Secret text：需要保存的一个加密的文本串，如钉钉机器人或Github的api token
Certificate：通过上传证书文件的方式
![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\8cef9cd4db28455488151a86303fd360.png)

常用的凭证类型有：
***Username with password***（用户密码）
***SSH Username with private key***（SSH密钥）

接下来以使用Git工具到Gitlab拉取项目源码为例，演示Jenkins的如何管理Gitlab的凭证。

#### 安装Git插件和Git工具

为了让Jenkins支持从Gitlab拉取源码，需要安装Git插件以及在CentOS7上安装Git工具。
Git插件安装：

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\0658685421794443a92713757f61b23a.png)

CentOS7上安装Git工具：

```
# yum安装git
yum install git -y
# 查看git版本
git --version 
```

#### 创建使用【用户密码类型】凭证

【系统管理】->【Manage Credentials】->【全局】->【添加一些凭据】

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\7907b1281f274384a2a37d300029e858.png)![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\c98edc35601a4e3ba889b3d6a92e592d.png)

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\5c136272e7774639a1454ee3c18373cc.png)

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\f64f7cc7ac844cb19eba08494c43909c.png)

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\f66c9e7fa73246e7b0cf010afa048328.png)

#### 创建使用【SSH密钥类型】凭证

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\68c042ebe4c0448ea94423c6dba9c469.png)

```bash
ssh-keygen -t rsa
```

#### Jenkins配置关联`Jdk`和`Maven`

##### 全局工具配置关联`Jdk`和`Maven`

需要先操作 “ **4、Maven Install and Configuration** ”
【系统管理】->【全局工具配置】->【**JDK**、**Maven**】->【应用、保存】

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\a4c4dd9eb78a4a2891698995132d9b40.png)

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\b4ca9d3f642c449d8311cb22ff94f5e7.png)

##### 添加Jenkins全局变量

【系统管理】->【Configure System】->【全局属性】->【环境变量】

添加三个变量：`JAVA_HOME`、`M2_HOME`、`PATH+EXTRA`

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\5e4912c9fcb9428c83937711c5f523cb.png)

### Maven Install and Configuration

`192.168.168.152`
在Jenkins集成服务器上安装Maven来编译和打包项目。

上传 **`apache-maven-3.6.2-bin.tar.gz`** 到 **`/opt/`** 文件夹

```bash
# 解压
tar -xzf apache-maven-3.6.2-bin.tar.gz
```

配置环境变量

```bash
# 配置java maven环境变量
cat > /etc/profile.d/myjava.sh <<-EOF
export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk
export MAVEN_HOME=/opt/apache-maven-3.6.2
export PATH=${PATH}:${JAVA_HOME}/bin:${MAVEN_HOME}/bin
EOF

# 配置生效
source /etc/profile
# 查找Maven版本
mvn -v

# 一定要记得创建仓库路径并赋予权限；不然后面maven构建会不成功的哦！！！
mkdir -p /opt/mavenrepo && chmod -R 777 /opt/mavenrepo
```

### Tomcat Install and Configuration

192.168.168.153

#### 安装jdk

```
# 安装jdk；此处使用openjdk
rpm -qa | grep java
rpm -e --nodeps java*
yum search jdk | grep java-1.8.0

yum install -y java-1.8.0-openjdk.x86_64 \
java-1.8.0-openjdk-accessibility.x86_64 \
java-1.8.0-openjdk-devel.x86_64 \
java-1.8.0-openjdk-headless.x86_64
# 安装目录为：/usr/lib/jvm
java -version
```

#### 安装tomcat

```
# 关闭防火墙
systemctl disable firewalld && systemctl stop firewalld
# 安装Tomcat8.5，上传压缩包到 /opt/ 目录
mkdir -p /opt/tomcat
tar -xzvf /opt/apache-tomcat-8.5.47.tar.gz --strip-components 1 -C /opt/tomcat
# 启动tomcat
/opt/tomcat/bin/startup.sh
```

访问Tomcat：**http://192.168.168.153:8080** 

####  配置tomcat权限

配置Tomcat用户角色权限，默认情况下Tomcat是没有配置用户角色权限的

```BASH
vim /opt/tomcat/conf/tomcat-users.xml

<tomcat-users>
  ...
  <role rolename="tomcat"/>
  <role rolename="role1"/>
  <role rolename="manager-script"/>
  <role rolename="manager-gui"/>
  <role rolename="manager-status"/>
  <role rolename="manager-jmx"/>
  <role rolename="admin-gui"/>
  <role rolename="admin-script"/>
  <user username="tomcat" password="tomcat" roles="tomcat,manager-script,manager-gui,admin-gui,admin-script,manager-jmx"/>
</tomcat-users>
```

**注意：为了能使配置的用户登录到Tomcat，还需要注释掉以下配置才可以！**

```
<!--
  <Valve className="org.apache.catalina.valves.RemoteAddrValve"
         allow="127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" />
-->
```

重启Tomcat，访问测试

```
# 停止
/opt/tomcat/bin/shutdown.sh
# 启动
/opt/tomcat/bin/startup.sh
```

测试：**http://192.168.168.153:8080/manager/html**

账号密码：**tomcat**/**tomcat**

Jenkins项目构建类型

### 构建的项目类型

Jenkins常用的自动构建项目的类型有以下三种：
自由风格软件项目（FreeStyle Project）
Maven项目（Maven Project）
流水线项目（Pipeline Project）
每种类型的构建其实都可以完成一样的构建过程与结果，只是在操作方式、灵活度等方面有所区别，在实际开发中可以根据自己的需求和习惯来选择。（PS：个人推荐使用流水线类型，因为灵活度非常高）

### 自由风格项目构建

拉取代码 -> 编译 -> 打包 -> 部署

#### 新建任务

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\101ae87ee09c43589d2664b35c49a982.png)

#### 配置从gitlab拉取代码

【具体项目x】->【源码管理】->【添加具体操作…】->【应用、保存】
jenkins拉取代码的默认存储路径：**`/var/lib/jenkins/workspace/`**

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\c435f0c8c82449f5b42a115ecaea49fa.png)

#### 编译打包

【具体项目x】->【构建】->【增加构建步骤】->【Executor Shell】->【添加具体操作…】->【应用、保存】

```
echo "开始编译和打包======================>>>>>>>>>>>>"
mvn clean package
echo "编译和打包结束======================>>>>>>>>>>>>"
```

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\19fd0b2a776b480dbb508b80fc11ecd6.png)

#### 部署项目到远程Tomcat

1）安装 Deploy to container插件
Jenkins本身无法实现远程部署到Tomcat的功能，需要安装 Deploy to container 插件实现。

2）添加构建后操作及Tomcat用户凭证
【具体项目x】->【配置】->【构建后操作】->【增加构建后操作步骤】->【Deploy war/ear to a container】->【添加具体操作…】->【应用、保存】

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\4fc10420945b444591de1a5da6c56546.png)

#### 构建及验证

【具体项目x】->【立即构建】

访问验证：http://192.168.168.153:8080/jenkins-web/

#### 改动代码后的持续集成

- 1）IDEA中源码修改并提交到gitlab
- 2）在Jenkins中项目重新构建
- 3）访问Tomcat

#### Maven项目构建

1）安装Maven Integration插件
从此处开始：因插件问题，jenkins 升级为 jenkins-2.361.1-1.1.noarch.rpm 版本！！！
**Maven Integration** 插件
2）创建Maven项目

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\f3e74bc9cbbf431ab73c4617d2e49dd9.png)

3）配置项目
拉取代码和远程部署的过程和自由风格项目一样，只是 “构建” 部分不同。

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\43506380fc41490e944a14e5b9ded6d6.png)

#### Pipeline流水线项目构建

#### Pipeline简介

Pipeline，简单说就是一套运行在 Jenkins 上的工作流框架，将原来独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂流程编排和可视化的工作。

  >使用Pipeline有以下好处（来自翻译自官方文档）：
  >代码：Pipeline以代码的形式实现，通常被检入源代码控制，使团队能够编辑，审查和迭代其传送流程。
  >持久：无论是计划内的还是计划外的服务器重启，Pipeline都是可恢复的。
  >可停止：Pipeline可接收交互式输入，以确定是否继续执行Pipeline。
  >多功能：Pipeline支持现实世界中复杂的持续交付要求。它支持fork/join、循环执行，并行执行任务的功能。
  >可扩展：Pipeline插件支持其DSL的自定义扩展 ，以及与其他插件集成的多个选项。

>如何创建 Jenkins Pipeline呢？
>Pipeline 脚本是由 Groovy 语言实现的，但没必要单独去学习 Groovy语言
>Pipeline 支持两种语法：Declarative(声明式)和 Scripted Pipeline(脚本式)语法
>Pipeline 也有两种创建方法：可以直接在 Jenkins 的 Web UI 界面中输入脚本；也可以通过创建一个 Jenkinsfile 脚本文件放入项目源码库中（一般推荐在 Jenkins 中直接从源代码控制(SCM)中直接载入 Jenkinsfile Pipeline 这种方法）

#### 安装Pipeline插件

【系统管理】->【插件管理】->【可选插件】Pipeline
A suite of plugins that lets you orchestrate automation, simple or complex. See Pipeline as Code with Jenkins for more details.

安装插件后，创建任务的时候多了“流水线”类型的任务。

#### Pipeline语法快速入门

##### Declarative声明式-Pipeline

创建项目 -> 流水线 ->选择 `Pipeline script` 选择 `Hello World` 模板生成内容如下：

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\ab423fce9bc94d9793573885e7f86ebf.png)

```bash
pipeline {
    agent any
    stages {
        stage('Hello') {
            steps {
                echo 'Hello World'
            }
        }
    }
}
```

stages：代表整个流水线的所有执行阶段。通常stages只有1个，里面包含多个stage。
stage：代表流水线中的某个阶段，可能出现n个。一般分为拉取代码，编译构建，部署等阶段。
steps：代表一个阶段内需要执行的逻辑。steps里面是shell脚本，git拉取代码，ssh远程发布等任意内容。
编写一个简单声明式Pipeline：

```bash
pipeline {
    agent any
    stages {
        stage('拉取代码') {
            steps {
                echo '拉取代码呀！！！'
            }
        }
        stage('编译构建') {
            steps {
                echo '编译构建呀！！！'
            }
        }
        stage('项目部署') {
            steps {
                echo '项目部署呀！！！'
            }
        }
    }
}
```

##### Scripted Pipeline脚本式-Pipeline

创建项目 -> 流水线 ->选择 `Pipeline script` -> 选择 `Scripted Pipeline` 模板生成内容如下：

```bash
node {
    def mvnHome
    stage('Preparation') { // for display purposes
        // Get some code from a GitHub repository
        git 'https://github.com/jglick/simple-maven-project-with-tests.git'
        // Get the Maven tool.
        // ** NOTE: This 'M3' Maven tool must be configured
        // **       in the global configuration.
        mvnHome = tool 'M3'
    }
    stage('Build') {
        // Run the maven build
        withEnv(["MVN_HOME=$mvnHome"]) {
            if (isUnix()) {
                sh '"$MVN_HOME/bin/mvn" -Dmaven.test.failure.ignore clean package'
            } else {
                bat(/"%MVN_HOME%\bin\mvn" -Dmaven.test.failure.ignore clean package/)
            }
        }
    }
    stage('Results') {
        junit '**/target/surefire-reports/TEST-*.xml'
        archiveArtifacts 'target/*.jar'
    }
}
```

node：节点，一个 Node 就是一个 Jenkins 节点，Master 或者 Agent，是执行 Step 的具体运行环境，后续讲到Jenkins的Master-Slave架构的时候用到。
stage：阶段，一个 Pipeline 可以划分为若干个 Stage，每个 Stage 代表一组操作，比如：Build、Test、Deploy，Stage 是一个逻辑分组的概念。
step：步骤，Step 是最基本的操作单元，可以是打印一句话，也可以是构建一个 Docker 镜像，由各类 Jenkins 插件提供，比如命令：sh ‘make’，就相当于我们平时 shell 终端中执行 make 命令一样。

编写一个简单的脚本式Pipeline

```bash
node {
    def mvnHome
    stage('拉取代码') { // for display purposes
        echo '拉取代码呀！！！！'
    }
    stage('编译构建') {
        echo '编译构建呀！！！！'
    }
    stage('项目部署') {
        echo '项目部署呀！！！！'
    }
}
```

##### Pipeline拉取代码

选择 【片段生成器】->【checkout: Check out from version control】

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\e4ebb4d64f2d4566abb98a1ff482f937.png)

```bash
pipeline {
  agent any
  stages {
    stage('拉取代码') {
      steps {
		checkout([$class: 'GitSCM', 
				  branches: [[name: '*/master']], 
				  extensions: [], 
				  userRemoteConfigs: [[credentialsId: '0ea1a070-8bae-439f-b81a-1aeffc6245e1', 
									   url: 'http://192.168.168.151:8000/test-jenkins/jenkins-web.git']]])
      }
    }
  }
}
```

##### Pipeline编译打包

选择 【片段生成器】->【sh: Shell Script】

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\2ba8e90b8ca04546a15d3f1ec466b83a.png)

```bash
pipeline {
  agent any
  stages {
    stage('拉取代码') {
      steps {
		checkout([$class: 'GitSCM', 
				  branches: [[name: '*/master']], 
				  extensions: [], 
				  userRemoteConfigs: [[credentialsId: '0ea1a070-8bae-439f-b81a-1aeffc6245e1', 
									   url: 'http://192.168.168.151:8000/test-jenkins/jenkins-web.git']]])
      }
    }
    stage('编译构建') {
      steps {
        sh 'mvn clean package'
        echo "这一行这样写 也行"
        echo "sh label: '', script: 'mvn clean package'"
      }
    }
  }
}
```

##### Pipeline部署项目

选择 【片段生成器】->【deploy: Delpoy war/ear to a container】

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\6b02f59536b04e4a8d474c3bbacc567c.png)

```bash
pipeline {
  agent any
  stages {
    stage('拉取代码') {
      steps {
		checkout([$class: 'GitSCM', 
				  branches: [[name: '*/master']], 
				  extensions: [], 
				  userRemoteConfigs: [[credentialsId: '0ea1a070-8bae-439f-b81a-1aeffc6245e1', 
									   url: 'http://192.168.168.151:8000/test-jenkins/jenkins-web.git']]])
      }
    }
    stage('编译构建') {
      steps {
        sh 'mvn clean package'
        echo "这一行这样写 也行"
        echo "sh label: '', script: 'mvn clean package'"
      }
    }
    stage('项目部署') {
      steps {
        deploy adapters: [tomcat8(credentialsId: '51df8b8a-5928-4fc5-8f68-ffd250d30f53', 
        						  path: '', 
        						  url: 'http://192.168.168.153:8080')], 
        	   contextPath: null, 
        	   war: 'target/*.war'
      }
    }
  }
}
```

##### Pipeline Script from SCM

刚才是直接在Jenkins的UI界面编写Pipeline代码，这样不方便脚本维护，建议把Pipeline脚本放在项目中（一起进行版本控制）。
1）在项目根目录建立Jenkinsfile文件，把Pipeline代码内容复制到该文件中，并将Jenkinsfile上传到Gitlab。

2）在Jenkins任务中引用该文件

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\423cd0c399ee467f9789e8ed267099ab.png)

### Jenkins项目构建细节

Jenkins内置4种构建触发器

#### 远程触发构建

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\8720d64ef7c34a64a12169c87eabc930.png)

**`JENKINS_URL/job/pipeline-jenkins-web/build?token=TOKEN_NAME`**
**`JENKINS_URL/job/pipeline-jenkins-web/buildWithParameters?token=TOKEN_NAME`**

#### 其他工程构建后触发

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\845d9008a9734906bb38837766b09cdc.png)

当 **构建指定的任务** 后，自动 **构建目标任务**

#### 定时构建

定时字符串规则从左往右分别为： 分 时 日 月 周

```bash
H/2 * * * *          每2分钟构建一次：H代表形参 8:02 8:04
H H/2 * * *          每2个小时构建一次: 
0 8,12,22 * * *      每天的8点，12点，22点，一天构建3次： (多个时间点中间用逗号隔开) 
H 12 * * *           每天中午12点定时构建一次 
H 18 * * *           每天下午18点定时构建一次 
H(0-29)/10 * * * *   在每个小时的前半个小时内的每10分钟 
H H(9-16)/2 * * 1-5  每两小时一次，每个工作日上午9点到下午5点(也许是上午10:38，下午12:38，下午2:38，下午4:38) 
```

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\6e1f0eb19db5494a9235ec97e50942a9.png)

#### 轮询SCM

轮询SCM，是定时扫描本地代码仓库的代码是否有变更，如果代码有变更就触发项目构建。

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\8cbc9af24ed24dde84b7f23c562f04a6.png)

注意：Jenkins会定时扫描本地整个项目的代码，增大系统的开销，不建议使用

#### Git hook自动触发构建

轮询SCM可以实现Gitlab代码更新，项目自动构建，但该方案性能不佳。
我们可以利用Gitlab的webhook实现代码push到仓库，立即触发项目自动构建。

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\16cb9b054fa345c1bdb6f3134677e685.png)

##### 安装 `Generic Webhook Trigger` 和 `GitLab` 插件

![img](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\ac2d20f9a3294630aa55a6f9abdb80c3.png)

##### Jenkins设置自动构建

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\e87e0d061a074840b4db47939c75bc46.png)

【Gitlab】-> 【关闭 Enable authentication for ‘/project’ end-point】

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\e48538ede9e14ca3bbd4418d001bf78a.png)

##### Gitlab设置Webhook

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\0cd34262818e4c47bc74e5164d046e88.png)

【具体项目xxx】->【Settings】->【Integrations】->【URL：填写Jenkins生成的url】->【Add webhook】

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\18c62d7af7cd4907a085a6dda35cb6bc.png)

#### Jenkins的参数化构建

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\1922d1caddda497d9d0bff7ea9f03744.png)

选择文本参数
project_branch
master

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\0fc3001b845345c8a04ae0189a5f68de.png)

![bran](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\931af972b4e74071a22dac11e101c6a2.png)

修改脚本 使用刚才配置的参数，提交

```bash
pipeline {
  agent any
  stages {
    stage('拉取代码') {
      steps {
		checkout([$class: 'GitSCM', 
				  branches: [[name: '*/${project_branch}']], 
				  extensions: [], 
				  userRemoteConfigs: [[credentialsId: '0ea1a070-8bae-439f-b81a-1aeffc6245e1', 
									   url: 'http://192.168.168.151:8000/test-jenkins/jenkins-web.git']]])
      }
    }
    stage('编译构建') {
      steps {
        sh 'mvn clean package'
        echo "这一行这样写 也行"
        echo "sh label: '', script: 'mvn clean package'"
      }
    }
    stage('项目部署') {
      steps {
        deploy adapters: [tomcat8(credentialsId: '51df8b8a-5928-4fc5-8f68-ffd250d30f53', 
        						  path: '', 
        						  url: 'http://192.168.168.153:8080')], 
        	   contextPath: null, 
        	   war: 'target/*.war'
      }
    }
  }
}
```

#### 配置邮箱服务器发送构建结果

##### 安装 `Email Extension Template` 插件

准备邮件内容

##### Jenkins设置邮箱相关参数

以163邮箱为例：
首先 邮箱要开启 **POP3/SMTP/IMAP**

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\411bbb22d7c24e2b8478550a5844c541.png)

开启之后，会生成一个 验证字符串，保存好 作为jenkins使用。
SMTP服务器: smtp.163.com

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\8bc8c9b7b2d24b30a2781888da6d6b1d.png)

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\f29affc7415d4f83b60a01a421440263.png)

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\d0e5612785ad4667894e8b03c9988007.png)

![在这里插入图片描述](D:\疯狂内卷文件\云计算省赛准备\省赛记忆手册github\Provincial-competition-memory-handbook\容器云\持久化集成.assets\abfe5d386daf40f2804c23c1084fa076.png)

Content Token Reference中有很多系统变量 可以使用

```bash
pipeline {
  agent any
  stages {
    stage('拉取代码') {
      steps {
		checkout([$class: 'GitSCM', 
				  branches: [[name: '*/${project_branch}']], 
				  extensions: [], 
				  userRemoteConfigs: [[credentialsId: '0ea1a070-8bae-439f-b81a-1aeffc6245e1', 
									   url: 'http://192.168.168.151:8000/test-jenkins/jenkins-web.git']]])
      }
    }
    stage('编译构建') {
      steps {
        sh 'mvn clean package'
        echo "这一行这样写 也行"
        echo "sh label: '', script: 'mvn clean package'"
      }
    }
    stage('项目部署') {
      steps {
        deploy adapters: [tomcat8(credentialsId: '51df8b8a-5928-4fc5-8f68-ffd250d30f53', 
        						  path: '', 
        						  url: 'http://192.168.168.153:8080')], 
        	   contextPath: null, 
        	   war: 'target/*.war'
      }
    }
  }
  post {
    always {
      emailext(
        subject: '构建通知：${PROJECT_NAME} - Build # ${BUILD_NUMBER} - ${BUILD_STATUS}!',
        body: '${FILE,path="email.html"}',
        to: 'michael_linux@163.com'
      )
    }
  }
}
pipeline {
  agent any
  stages {
    stage('拉取代码') {
      steps {
		checkout([$class: 'GitSCM', 
				  branches: [[name: '*/${project_branch}']], 
				  extensions: [], 
				  userRemoteConfigs: [[credentialsId: '0ea1a070-8bae-439f-b81a-1aeffc6245e1', 
									   url: 'http://192.168.168.151:8000/test-jenkins/jenkins-web.git']]])
      }
    }
    stage('编译构建') {
      steps {
        sh 'mvn clean package'
        echo "这一行这样写 也行"
        echo "sh label: '', script: 'mvn clean package'"
      }
    }
    stage('项目部署') {
      steps {
        deploy adapters: [tomcat8(credentialsId: '51df8b8a-5928-4fc5-8f68-ffd250d30f53', 
        						  path: '', 
        						  url: 'http://192.168.168.153:8080')], 
        	   contextPath: null, 
        	   war: 'target/*.war'
      }
    }
  }
  post {
    always {
      emailext(
        subject: '构建通知：${PROJECT_NAME} - Build # ${BUILD_NUMBER} - ${BUILD_STATUS}!',
        body: '${FILE,path="email.html"}',
        to: 'michael_linux@163.com'
      )
    }
  }
}
```

### Jenkins+SonarQube代码审查

#### 安装SonarQube

#### 实现代码审查
